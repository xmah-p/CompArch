
# 课程概述

# 计算机基本结构

## 电子计算机的兴起

**现代电子计算机之父**：冯·诺依曼

ENIAC（Electronic Numerical Integrator and Computer，电子数字积分器和计算机）：

- 首台**通用**电子计算机
- 1946年2月14日
- 1943年开始设计
- 宾夕法尼亚大学
- 约翰·莫克利（首席顾问）、约翰·埃克特（首席工程师）、约翰·冯·诺依曼

ABC（Atanasoff-Berry Computer，阿塔纳索夫-贝里计算机）：

- 比 ENIAC 早，1939年完成
- 首台计算机

冯诺依曼提出**存储程序**概念，在《关于EDVAC的报告草案》提出了冯诺依曼结构。

EDVAC（Electronic Discrete Variable Automatic Computer，电子离散变量自动计算机）：

- 1949年8月交付
- 1951年开始运行
- 冯诺依曼结构
- 存储程序
- 指令和数据采用二进制，简化了逻辑线路
- 五个基本部分：
  - 运算器
  - 控制器
  - 存储器
  - 输入设备
  - 输出设备
- 但第一台冯诺依曼结构计算机是 EDSAC（1949年正式运行）

UNIVAC（UNIVersal Automatic Computer，通用自动计算机）：1951 年交付，1952 年统计选票一战成名，开启了商用计算机时代。

其他经典计算机：

- 1964 年大型计算机 IBM S/360
- 1964 年超级计算机 CDC 6600
- 1965 年小型计算机 PDP-8
- 1975 年微型计算机 Altair 8800
- 1977 年微型计算机 Apple II
- 1981 年微型计算机 IBM PC 5150

## 模型机

存储器（主存）：

- 控制总线连接控制逻辑和地址译码器
- 地址总线连接 Memory Address Register（MAR）
- 数据总线连接 Memory Data Register（MDR）

控制器：

- 指令寄存器（IR）：存当前指令
- 程序计数器（PC）：存下一条指令的地址
- MAR
- MDR
- 指令译码部件
- 控制电路

运算器：

- ALU：算术运算和逻辑运算
- 通用寄存器
- 状态寄存器

CPU：控制器和运算器

总线：

- 内部总线：CPU 内部
- 控制总线：控制器的控制电路和存储器控制逻辑
- 地址总线：存储器 MAR 和控制器 MAR
- 数据总线：存储器 MDR 和控制器 MDR

执行指令的四个步骤：取指、译码、执行、回写

输入输出：就像另一个存储器

## 现代计算机

现代计算机结构：

- CPU
- 北桥：PCIe 控制器、主存控制器、集显
- 南桥：I/O 控制器（硬盘、USB、网卡、PCI 卡、...）

后来，主存控制器、PCIe 控制器、集显（核显）都集成在 CPU 里了。主板只剩下一个 PCH 管 I/O。

再后来发展出了 SOC（System on Chip，片上系统）。

摩尔定律（常见描述）：价格不变，每 18 个月，集成电路上可容纳的晶体管数目翻一番。


# 指令集

简单的指令集示例：

- 运算类：`ADD R, M`
- 传送类：`LOAD R, M`、`STORE M, R`
- 转移类：`JMP L`
- 格式：4 位操作码 + 4 位寄存器号 + 8 位地址

## x86 体系结构

### 16 位时代：x86-16（IA-16）

Intel 8086：

- 1978 年发布
- 16 位通用寄存器，也支持 8 位数据
- 16 根数据线
- 20 根地址线，寻址空间 1MB
- 段 + 偏移量寻址
- 代表计算机 IBM 5150（用的是简化版的 8088）

8086 的寄存器模型：

- 通用寄存器
  - 4 个数据寄存器：AX、BX、CX、DX
    - 每个可分为两个 8 位寄存器使用：AL/AH、BL/BH、CL/CH、DL/DH
  - 指针和变址寄存器：SP、BP、SI、DI
- 指令指针寄存器：IP
- 标志寄存器：FLAGS
  - 标志位有：
    - 状态标志位：CF（进位）、ZF（零）、SF（符号）、OF（溢出）、PF（奇偶）、AF（辅助进位）
    - 控制标志位：DF（方向）、IF（中断）、TF（跟踪）
- 段寄存器：CS、DS、SS、ES
  - CS：代码段寄存器，指向当前执行的代码段
  - DS：数据段寄存器，指向当前数据段
  - SS：堆栈段寄存器，指向当前堆栈段
  - ES：附加数据段寄存器

8086 的寻址方式：

- 指令指针寄存器（IP）保存**下一条指令的地址**（即程序计数器）
- 程序员不能直接操作 IP
- 物理地址 = 段寄存器 * 16 + IP
- 1MB 的存储空间分为许多 64KB 的逻辑段，它们可以重叠
- 指令的操作数默认存放在数据段（DS）中，指令地址默认存放在代码段（CS）中

Intel 80286：

- 24 位地址总线，寻址空间 16MB
- 保护模式，但有缺陷（每个段只有 64KB）
- 实模式（兼容 8086）
- 所有 x86 处理器在加电启动时都首先进入实模式，系统初始化完成后再进入保护模式

### 32 位时代：IA-32

Intel 80386：

- 8086 系列的首款 32 位处理器
- 32 位通用寄存器
- 32 位地址总线，寻址空间 4GB
- 改进的保护模式：段可达 4GB
  - 保护模式是主要工作模式，支持多任务、特权级、特权指令、访问权限、4GB 物理地址空间、虚拟内存
- 虚拟 8086 模式，可以模拟多个 8086 处理器
  - 寻址空间 1MB，段 + 偏移寻址（与实模式相同）
  - 对中断和异常的处理不同于实模式
  - 用于兼容 8086 系统

IA-32 对寄存器模型的扩展：

- 通用寄存器（AX -> EAX）
- 指令指针寄存器（IP -> EIP）
- 标志寄存器（FLAGS -> EFLAGS）
- 段寄存器仍然都为 16 位，增加了 FS 和 GS 两个段寄存器

IA-32 的寻址方式：

- 实模式：CS:IP
- 保护模式：
  - Global Descriptor Table（GDT）：全局描述符表，由 8 字节的描述符组成，包含段基址、段界限等信息
  - GDTR：GDT 寄存器，存放 GDT 的基址和界限
  - CS：存放段选择子
  - 段基址由根据 GDTR 和 CS，查内存中的 GDT 得到
  - EIP：存放指令的段内偏移地址
- 物理地址 = 段基址 + 段内偏移地址

### 64 位时代：x86-64

AMD Opteron：

- 首款 64 位 x86 处理器
- 兼容 IA-32，且不降低性能

x86-64 的运行模式：

- 长模式：64 位 OS
  - 64 位模式：需要重新编译
  - 兼容模式：不需要重新编译
- 传统模式：都不需要重新编译
  - 保护模式：32 位或 16 位 OS
  - 虚拟 8086 模式：32 位或 16 位 OS
  - 实模式：16 位 OS

x86-64 对寄存器模型的扩展：

- 通用寄存器（EAX -> RAX），并且增加了 R8-R15 寄存器
- 指令指针寄存器（EIP -> RIP）
- 标志寄存器（EFLAGS -> RFLAGS）
- 段寄存器没有变化，仍然为 6 个 16 位寄存器（CS、DS、SS、ES、FS、GS）

x86-64 半废除了 GDT 寻址，GDT 描述符表的基址和界限都为 0，段选择子也不再使用，通过分页寻址。

## x86 指令简介

主要分为传送类、运算类（又可分为算术、逻辑）、控制类、转移类。

字节（BYTE）为 8 位，字（WORD）为 16 位，双字（DWORD）为 32 位，四字（QWORD）为 64 位。

Intel 语法：`MOV WORD PTR [BX + SI*2 + 200H], 01H`

- 目的在前，源在后
- `[]` 表示内存地址
- `WORD PTR` 表示操作数大小
- `H` 后缀表示十六进制，`D` 表示十进制，`B` 表示二进制，`O` 表示八进制

MOV：

- 立即数不能为目的
- 不能在存储器之间传送，不能在段寄存器之间传送
- 不能将立即数传送到段寄存器
- CS 不能为目的

栈操作：PUSH、POP

LEA：将地址（而不是地址中的数据）传送到通用寄存器中

算术运算指令：

- 目的不能是立即数或 CS
- 源和目的不能都是存储器
- 加法：ADD、ADC（目的 + 源 + CF）、INC
- 减法：SUB、SBB（目的 - 源 - CF）、DEC、CMP（DST - SRC，但不写回目的，只设置标志位）

逻辑运算指令：

- 单操作数指令，操作数不能是立即数
- 双操作数指令，限制同 MOV 指令（目的不能是立即数或 CS，源和目的不能都是存储器也不能都是段寄存器，不能将立即数传送到段寄存器）
- NOT、AND
- SHL 逻辑左移（乘 $2^n$）
- SHR 逻辑右移，SAR 算术右移（除以 $2^n$）

转移指令：

- 无条件转移：
  - 直接转移
    - `JMP SHORT LABEL`：LABEL 是地址，指令中存储的是 IP 到 LABEL 的 8 位偏移量，范围 -128 ~ 127。执行效果：`IP = IP + OFFSET`
    - `JMP NEAR PTR LABEL`：16 位偏移量，范围 -32768 ~ 32767（80386 支持 32 位偏移量）。执行效果：`IP = IP + OFFSET`
    - `JMP FAR PTR LABEL`：指令中存储的是 LABEL。执行效果：`CS = LABEL.CS`、`IP = LABEL.IP`
  - 间接转移：`JMP AX`、`JMP [BX]`、`JMP FAR PTR [SI]`（执行效果如 `IP = [SI]; CS = [SI + 2]`）
- 条件转移：
  - `C`：进位
  - `P`：奇偶
  - `Z`/`E`：零/相等
  - `S`：符号（负数）
  - `O`：溢出
  - `B(E)`、`A(E)`：小于 (等于)/大于 (等于)（无符号数）
  - `L(E)`、`G(E)`：小于 (等于)/大于 (等于)（有符号数）

处理器控制指令：

- 标志操作
  - STC：设置进位标志 CF
  - CLC：清除进位标志 CF
  - CMC：取反进位标志 CF
- 外同步：HLT（停止 CPU）
- NOP

复杂 x86-64 指令举例：串操作指令

- 串的基本单位：字节（BYTE）或字（WORD）
- 串长可达 64KB
- 五种串操作指令：MOVS、CMPS、SCAS、LODS、STOS，每种有 B 和 W 两种形式
- 三种重复前缀：REP、REPE、REPNE
- 隐含操作数：
  - 源串：DS:SI
  - 目的串：ES:DI
  - 串长：CX
  - 方向标志 DF（0：从低地址到高地址，1：从高地址到低地址）
- 传送过程中，SI、DI、CX 自动更新

## MIPS 体系结构

设计者：约翰·亨尼西

RISC（Reduced Instruction Set Computer，精简指令集计算机）、CISC（Complex Instruction Set Computer，复杂指令集计算机）

MIPS（Microprocessor without Interlocked Pipeline Stages，微处理器无互锁流水线阶段）：

- 32 位定长指令
- 指令少、简单
- 仅 Load/Store 指令可访问内存
- 寻址简单
- 需要优秀的编译器

MIPS 的通用寄存器：`$0` - `$31`，分为若干组。

MIPS 指令分为 R 型、I 型、J 型：

- R 型：
  - 格式：[6 位 opcode, 5 位 rs, 5 位 rt, 5 位 rd, 5 位 shamt, 6 位 funct]
  - 所有 R 型指令的 opcode 都为 0，funct 决定具体指令
  - shamt：移位量，只对移位指令有效
  - rs、rt：源寄存器，rd：目的寄存器
- I 型：
  - 格式：[6 位 opcode, 5 位 rs, 5 位 rt, 16 位 immediate]
  - 与 R 型指令的区别：无 shamt、rd、funct
  - rs：源寄存器，rt：目的寄存器
  - immediate：立即数或地址偏移量
- J 型：
  - 格式：[6 位 opcode, 26 位 address]
  - 无条件跳转
  - 目的地址 = {PC[31:28], address, 00}，即 PC 的高 4 位 + 指令中的地址 + 00（低两位）
  - MIPS 指令 32 位定长，所有指令地址都是 32 位（4 字节）对齐的，所以低两位都是 00

分支指令：

- 条件分支：I 型
  - BEQ/BNE rs, rt, offset：如果 rs 和 rt 相等（不相等），则跳转到 (PC + 4) + offset * 4
- 无条件分支：J 型和 R 型
  - `j addr`：正负 256MB 跳转
  - `jr rs`：4GB 跳转

